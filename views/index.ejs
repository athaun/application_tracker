<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    
    <!-- Add Job Form Modal -->
    <div class="modal fade modal-lg" id="addJobModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add a Job Application</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="jobForm">
                        <div class="mb-2">
                            <label class="form-label">Company</label>
                            <input type="text" class="form-control" name="company" required list="companyList">
                            <datalist id="companyList"></datalist>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Position</label>
                            <input type="text" class="form-control" name="position" required list="positionList">
                            <datalist id="positionList"></datalist>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Posting URL</label>
                            <div class="input-group">
                                <input type="url" class="form-control" name="posting" id="jobUrl">
                                <button class="btn btn-secondary" type="button" id="parseJob">
                                    <span id="parseJobSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    Parse details
                                </button>
                            </div>
                        </div>
                       
                        <div class="mb-2">
                            <label class="form-label">Job Code</label>
                            <input type="text" class="form-control" name="jobCode">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="notes" rows="8"></textarea>
                        </div>

                        <script>
                            $(document).ready(function() {
                                $('#parseJob').on('click', function() {
                                    console.log("Parsing job details...");
                                    const url = $('#jobUrl').val();
                                    const notesContent = $('textarea[name="notes"]').val();

                                    let parsingUrl = true;
                                    if (notesContent.length > 0) {
                                        parsingUrl = false;
                                    }

                                    const button = $(this);
                                    const spinner = $('#parseJobSpinner');

                                    if (!url && !notesContent) {
                                        alert("Please enter a URL or notes content to parse.");
                                        return;
                                    }

                                    // Show spinner and disable button
                                    spinner.removeClass('d-none');
                                    button.prop('disabled', true);

                                    fetch('/api/llm/parse', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ 
                                            url: url, 
                                            notesContent: notesContent, 
                                            parsingUrl: parsingUrl
                                        })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        
                                        $('textarea[name="notes"]').val('');

                                        const { title, jobCode, requirements, description, skills, company, contact, location, salary } = data;

                                        console.log(data);

                                        // Populate the form fields with parsed details
                                        $('input[name="position"]').val(title || '');
                                        $('input[name="jobCode"]').val(jobCode || '');
                                        if (Array.isArray(requirements)) {
                                            $('textarea[name="notes"]').val((_, currentValue) => currentValue + 'Requirements:\n' + requirements.map(req => `• ${req}`).join('\n'));
                                        }
                                        if (description) {
                                            $('textarea[name="notes"]').val((_, currentValue) => currentValue + '\n\nDescription:\n' + description);
                                        }
                                        if (Array.isArray(skills)) {
                                            $('textarea[name="notes"]').val((_, currentValue) => currentValue + '\n\nSkills:\n' + skills.map(skill => `• ${skill}`).join('\n'));
                                        }
                                        if (location && location != "Not found") {
                                            $('textarea[name="notes"]').val((_, currentValue) => currentValue + '\n\nLocation:\n' + location);
                                        }
                                        if (salary && salary != "Not found") {
                                            $('textarea[name="notes"]').val((_, currentValue) => currentValue + '\n\nSalary:\n' + salary);
                                        }
                                        $('input[name="company"]').val(company || '');
                                        $('input[name="contact"]').val(contact || '');
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                    })
                                    .finally(() => {
                                        // Hide spinner and enable button
                                        spinner.addClass('d-none');
                                        button.prop('disabled', false);
                                    });
                                });
                            });
                        </script>
                        
                        <br>                      
                        
                        <div class="mb-2">
                            <label class="form-label">Contact</label>
                            <input type="text" class="form-control" name="contact">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Date Applied</label>
                            <input type="date" class="form-control" id="newJobDate" name="date" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" id="statusSelector">
                                <option value="Applied">Applied</option>
                                <option value="Interview">Interview</option>
                                <option value="Offer">Offer</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </div>   
                        
                        <br>

                        <button type="submit" class="btn btn-warning w-100">Add Job</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    $(document).ready( function() {
        $('#addJobModal').on('shown.bs.modal', function () {
            $('#jobForm').find('input, textarea, select').not('#statusSelector').val('');

            $('#jobForm input:first').focus(); // Focus first input field
            
            // Get YYYY-MM-DD format
            $('#newJobDate').val(new Date().toISOString().split('T')[0]);   
        });

        document.getElementById('jobForm').addEventListener('submit', function(event) {
            event.preventDefault(); 
            
            let formData = new FormData(this);
            let jsonObject = {};
            
            formData.forEach((value, key) => {
                jsonObject[key] = value;
            });

            fetch('/api/jobs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonObject)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error");
            })
        });
    });
    </script>

    <div class="container mt-5">

        <%- include('partials/stats') %>


        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addJobModal">
            Add Job Application
        </button>
        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#resumeModal">
            Manage Resumes
        </button>
        <br><br>

        <div class="input-group mb-3">
            <input type="text" id="search" class="form-control" placeholder="Search jobs..." list="searchList">
        </div>
        <datalist id="searchList"></datalist>
        <table class="table table-striped" id="jobTable">
            <thead>
                <tr>
                    <th data-column="company" class="sortable">Company</th>
                    <th data-column="position" class="sortable">Position</th>
                    <th data-column="code" class="sortable">Code</th>
                    <th data-column="date" class="sortable">Date</th>
                    <th data-column="status" class="sortable">Status</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>

    <!-- Job Detail Modal -->
    <div class="modal fade modal-lg" id="jobModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Job Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editJobForm">
                        <div class="mb-3">
                            <label class="form-label">Company</label>
                            <input type="text" class="form-control" id="editCompany" name="company">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Position</label>
                            <input type="text" class="form-control" id="editPosition" name="position">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date Applied</label>
                            <input type="date" class="form-control" id="editDate" name="date">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-control" id="editStatus" name="status">
                                <option value="Applied">Applied</option>
                                <option value="Interview">Interview</option>
                                <option value="Offer">Offer</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editNotes" name="notes" rows="8"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Job Code</label>
                            <input type="text" class="form-control" id="editJobCode" name="jobCode">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Posting URL <a id="postingUrl" href="#" target="_blank">(Visit)</a></label>
                            <input type="url" class="form-control" id="editPosting" name="posting">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contact</label>
                            <input type="text" class="form-control" id="editContact" name="contact">
                        </div>
                        
                        <input type="hidden" id="editJobId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" id="deleteJob">Delete</button>
                    <button class="btn btn-warning" id="saveJob">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>
    $(document).ready(function() {
        let jobs = [];
        let sortOrder = 1;

        function fetchJobs() {
            $.get('/api/jobs', function(data) {
                jobs = data;
                jobs.sort((a, b) => new Date(b.date) - new Date(a.date));

                $('#search').val('');

                renderTable(jobs);

                let searchList = $('#searchList');
                searchList.empty(); // Clear any existing options

                // Autocomplete for company input
                let companies = [...new Set(jobs.map(job => job.company))]; // Get unique company names
                let companyList = $('#companyList');
                companyList.empty(); // Clear any existing options
                companies.forEach(company => {
                    companyList.append(new Option(company));
                    searchList.append(new Option(company));
                });

                // Autocomplete for position input
                let positions = [...new Set(jobs.map(job => job.position))]; // Get unique position names
                let positionList = $('#positionList');
                positionList.empty(); // Clear any existing options
                positions.forEach(position => {
                    positionList.append(new Option(position));
                    searchList.append(new Option(position));
                });

                // Autocomplete for status input
                let statuses = [...new Set(jobs.map(job => job.status))]; // Get unique status names
                statuses.forEach(status => {
                    searchList.append(new Option(status));
                });

                // Autocomplete for job code input
                let jobCodes = [...new Set(jobs.map(job => job.jobCode))]; // Get unique job code names
                jobCodes.forEach(jobCode => {
                    searchList.append(new Option(jobCode));
                });

            });
        }

        function renderTable(jobs) {
            let tbody = $('#jobTable tbody');
            tbody.empty();
            jobs.forEach(job => {
                let pillColor = "secondary";
                switch (job.status) {
                    case "Rejected":
                        pillColor = "warning";
                        break;
                    case "Interview":
                        pillColor = "primary";
                        break;
                    case "Offer":
                        pillColor = "success";
                        break;
                }

                tbody.append(`<tr data-id="${job._id}" class="job-row">
                    <td>${job.company}</td>
                    <td>${job.position}</td>
                    <td>${job.jobCode}</td>
                    <td>${new Date(job.date).toLocaleDateString()}</td>
                    <td><span class="badge rounded-pill text-bg-${pillColor}">${job.status}</span></td>
                </tr>`);
            });
        }

        $('#search').on('input', function() {
            let query = $(this).val().toLowerCase();
            let filtered = jobs.filter(job => 
                job.company.toLowerCase().includes(query) ||
                job.position.toLowerCase().includes(query) ||
                job.status.toLowerCase().includes(query) ||
                job.jobCode.toLowerCase().includes(query) || 
                job.contact.toLowerCase().includes(query) || 
                job.notes.toLowerCase().includes(query)
            );
            renderTable(filtered);
        });

        $('.sortable').on('click', function() {
            let column = $(this).data('column');
            sortOrder *= -1;
            jobs.sort((a, b) => (a[column] > b[column] ? 1 : -1) * sortOrder);
            renderTable(jobs);
        });

        $(document).on('click', '.job-row', function() {
            let jobId = $(this).data('id');
            $.get(`/api/jobs/${jobId}`, function(job) {
                $('#editJobForm').find('input, textarea, select').each(function() {
                    let fieldName = $(this).attr('name');
                    if (fieldName === 'date' && job.date) {
                        $(this).val(new Date(job.date).toISOString().split('T')[0]); 
                    } else {
                        $(this).val(job[fieldName] || '');
                    }
                });

                console.log(job)
                $("#postingUrl").attr("href", job.posting);
                $('#editJobId').val(job._id);
                $('#jobModal').modal('show');
            });
        });

        $('#saveJob').on('click', function() {
            let id = $('#editJobId').val();
            let data = $('#editJobForm').serialize();
            $.ajax({ url: `/api/jobs/${id}`, method: 'PUT', data }).done(() => location.reload());
        });

        $('#deleteJob').on('click', function() {
            let id = $('#editJobId').val();
            $.ajax({ url: `/api/jobs/${id}`, method: 'DELETE' }).done(() => location.reload());
        });

        fetchJobs();
    });
    </script>

<!-- Resume Management Modal -->
    <div class="modal fade modal-lg" id="resumeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Resume Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col">
                            <form id="uploadResumeForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="resumeName" class="form-label">Resume Name</label>
                                    <input type="text" class="form-control" id="resumeName" name="resumeName" required placeholder="e.g., AI_focused_resume">
                                </div>
                                <div class="mb-3">
                                    <label for="resumeFile" class="form-label">Upload Resume</label>
                                    <input class="form-control" type="file" id="resumeFile" name="resumeFile" accept=".pdf,.doc,.docx" required>
                                </div>
                                <div class="mb-3">
                                    <label for="resumeNotes" class="form-label">Notes (optional)</label>
                                    <textarea class="form-control" id="resumeNotes" name="resumeNotes" rows="2" placeholder="Optional description of this resume version"></textarea>
                                </div>
                                <button type="submit" class="btn btn-warning">Upload Resume</button>
                            </form>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col">
                            <h5>Your Resumes</h5>
                            <div id="resumesList" class="list-group mt-3">
                                <!-- Resumes will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function() {
        // Load resumes when the modal is opened
        $('#resumeModal').on('shown.bs.modal', function() {
            loadResumes();
        });

        // Handle resume upload
        $('#uploadResumeForm').on('submit', function(event) {
            event.preventDefault();

            const formData = new FormData();
            const resumeName = $('#resumeName').val();
            const resumeFile = $('#resumeFile')[0].files[0];
            const resumeNotes = $('#resumeNotes').val();

            formData.append('resumeName', resumeName);
            formData.append('resumeFile', resumeFile);
            formData.append('resumeNotes', resumeNotes);

            // Show loading indicator or disable button here if desired

            $.ajax({
                url: '/api/resumes',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log('Resume uploaded successfully:', response);
                    // Reset form
                    $('#uploadResumeForm')[0].reset();
                    // Reload resumes list
                    loadResumes();
                },
                error: function(error) {
                    console.error('Error uploading resume:', error);
                    alert('Failed to upload resume. Please try again.');
                }
            });
        });

        // Function to load all resumes
        function loadResumes() {
            $.get('/api/resumes', function(resumes) {
                const resumesList = $('#resumesList');
                resumesList.empty();

                if (resumes.length === 0) {
                    resumesList.append('<p class="text-muted">No resumes uploaded yet.</p>');
                    return;
                }

                resumes.forEach(resume => {
                    const lastUpdated = new Date(resume.updatedAt).toLocaleDateString();
                    const item = `
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <h6>${resume.name}</h6>
                                <small class="text-muted">
                                    Updated: ${lastUpdated}
                                    ${resume.notes ? '<br>' + resume.notes : ''}
                                </small>
                            </div>
                            <div>
                                <a href="/api/resumes/${resume._id}/download" class="btn btn-sm btn-success me-2" title="Download">
                                    <i class="bi bi-download"></i> Download
                                </a>
                                <button class="btn btn-sm btn-danger delete-resume" data-id="${resume._id}" title="Delete">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    resumesList.append(item);
                });
            });
        }

        // Handle resume deletion
        $(document).on('click', '.delete-resume', function() {
            const resumeId = $(this).data('id');

            if (confirm('Are you sure you want to delete this resume?')) {
                $.ajax({
                    url: `/api/resumes/${resumeId}`,
                    type: 'DELETE',
                    success: function() {
                        console.log('Resume deleted successfully');
                        loadResumes();
                    },
                    error: function(error) {
                        console.error('Error deleting resume:', error);
                        alert('Failed to delete resume. Please try again.');
                    }
                });
            }
        });
    });
    </script>
</body>
</html>